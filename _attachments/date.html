<!DOCTYPE html>
<html>
  <head>
    <script src="vendor/couchapp/loader.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.0/jquery-ui.min.js"></script>
    <script src="vendor/couchapp/jquery.tablesorter.min.js"></script>
    <script src="lobbying.js"></script>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.2r1/build/reset/reset-min.css">
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <title>Browse Lobbyist Spending by Date</title>
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<style>
    #months { margin-left: 1em; }
    #months td { padding-right: 1em; }
    #months .value { width: 200px; }
    .start { border-top: 2px solid black; }
    .bar { background-color: #7CD3B5; }
</style>
  </head>
  <body>
<h1>Lobbyist Spending by Month</h1>
<table id="months" class="tablesorter">
    <thead><tr><th>Month</th><th>Amount</th></tr></thead>
    <tbody></tbody>
</table>

  </body>
  <script>

$db = $.couch.db("lobbying");
var key_data_cache = {};

function load_data_month(parentRow, month){
    log("Load Month",parentRow,month);
    $db.view("lobbying/month-to-amount", {
        group_level: 2,
        startkey: [month],
        endkey: [month, {}],
        success: function(jsonData){
            jsonData.rows.forEach(function(row){
                $('<p title="' + row.key[1] + '">' + row.value + '</p>').appendTo(parentRow);

            });
        }
    });
}

(function load_data(){
    log("Load Keys");
    $db.view("lobbying/month-to-amount", {
        group_level: 1,
        success: function(jsonData){
            var keys = $('#months > tbody');
            var now = new Date,
                now = now.getYear() + "" + now.getMonth();
            jsonData.rows.forEach(function(row){
                var date = row.key[0];
                if (date <= now) {
                    var year = Math.floor(date/100) + 1900;
                    var month = (date % 100) + 1;
                    elem = $('<tr' + (month == 1 ? ' class="start"' : '')  + '><td class="date">' + year + '/' + month + '</td><td class="value">' + row.value + '</td></tr>')
                        .one('click', function(){ load_data_month($(this).children('td.value'), date); })
                        .appendTo(keys);
                }
            });
            $('#months').tablesorter().tablebars();
        }
    });
})();


  </script>
</html>
